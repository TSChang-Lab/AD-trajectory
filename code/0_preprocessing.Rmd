---
title: "0_data_preprocessing"
author: "Joy_Fu"
date: "2023-02-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list = ls())
pacman::p_load(tidyverse)

raw_data_path = "/Users/Mingzhou/Desktop/Projects/AD-trajectory/data/"
output_path = "/Users/Mingzhou/Desktop/Projects/AD-trajectory/output/"

# Source in useful functions
# source("code/functions.R")
```

# Part 1. Preprocessing of AD cases
## 1. Restrict to 3-digit valid ICD (with distance metric)
```{r}
AD_encounters_raw = read_csv(file = paste0(raw_data_path, 'raw/AD_encounters_02032023.csv'), col_names = F)
colnames(AD_encounters_raw) = c("PatientID", "EncounterID", "EncounterDate", "EncounterType", "FirstADDate", "DiagnosisCode", "DiagnosisName")
dim(AD_encounters_raw) # dim = (8884165,7)
# Clean raw data
AD_encounters_clean = AD_encounters_raw %>% 
  mutate(EncounterDate = as.Date(EncounterDate), FirstADDate = as.Date(FirstADDate)) %>% 
  mutate(ICD_3digit = substr(DiagnosisCode, 1, 3)) %>% 
  select(PatientID, EncounterID, EncounterDate, ICD_3digit) %>% unique()
dim(AD_encounters_clean) # dim = (4965955,4)
rm(AD_encounters_raw)
# Keep only ICD codes in distance metrics
load('/Users/Mingzhou/Desktop/Projects/Disease.Similarity/GitHub/data/dist_final_full.rda')
icd_lst = dist_final_full %>% filter(!is.na(embed_dist)) %>% pull(ICD1) %>% unique() # N = 1619
AD_encounters_valid = AD_encounters_clean %>% 
  filter(ICD_3digit %in% icd_lst)
dim(AD_encounters_valid) # dim = (3835880,4)
```

## 2. Preprocessing of EHR features
### Merge with demographics
```{r}
# Get demographic info
AD_patients_raw = read_csv(file = paste0(raw_data_path, 'raw/AD_patients_02032023.csv'), col_names = F)
colnames(AD_patients_raw) = c("PatientID", "Sex", "PreferredLanguage", "Ethnicity", "FirstRace", "BirthDate")
dim(AD_patients_raw) # dim = (8562,6)
# Merge demo with encounters
white_group = c("White or Caucasian", "European", "White", "White: Not Listed", "Arab", "Egyptian", "Israeli", "Iranian", "Lebanese")
black_group = c("Black", "Black: African American", "Black or African American: Not Listed", "African American", "African")
american_group = c("American Indian or Alaska Native", "Armenian", "American Indian", "Caribbean/West Indian", "Indigenous")
east_asian_group = c("Asian", "Asian: Chinese", "Chinese", "Asian: Filipino", "Filipino", "Asian: Korean", "Korean",
                     "Asian: Japanese", "Japanese", "Asian: Vietnamese", "Vietnamese", "Taiwanese", "Thai", "Burmese", "Fijian")
south_asian_group = c("Asian: Pakistani", "Pakistani", "Asian: Asian Indian", "Indian (India)", "Palestinian", "Assyrian")  
pacific_group = c("Pacific Islander: Other", "Pacific Islander: Not Listed", "Pacific Islander: Native Hawaiian", "Pacific Islander: Samoan",
                  "Pacific Islander: Guamanian or Chamorro", "Native Hawaiian or Other Pacific Islander")
unknown_group = c("Choose Not to Answer", "Declined to Specify", "Do not identify with Race", "Not Listed", "NULL", "Unknown")
hispanic_group = c("Hispanic or Latino", "Hispanic/Spanish origin Other", "Puerto Rican", "Mexican, Mexican American, Chicano/a", "Cuban")
# Assign race/ethnicity groups
AD_patients_clean = AD_patients_raw %>% 
  mutate(BirthDate = as.Date(BirthDate)) %>% 
  select(PatientID, Sex, FirstRace, Ethnicity, BirthDate) %>% 
  mutate(race_ethnicity = case_when(
    Ethnicity %in% hispanic_group ~ "Hispanic",
    FirstRace %in% white_group ~ "White",
    FirstRace %in% black_group ~ "Black",
    FirstRace %in% american_group ~ "American",
    FirstRace %in% east_asian_group ~ "EastAsian",
    FirstRace %in% south_asian_group ~ "SouthAsian",
    FirstRace %in% pacific_group ~ "Pacific",
    FirstRace %in% c("Asian: Not Listed", "Asian: Other", "Other Race") ~ "Others",
    FirstRace %in% unknown_group ~ "Unknown"
  )) %>% select(PatientID, Sex, BirthDate, race_ethnicity)
# Merge together
AD_merged = AD_encounters_valid %>% left_join(AD_patients_clean) %>% 
  filter(!is.na(Sex) & !is.na(BirthDate)) %>% 
  filter(Sex != "Unknown") 
dim(AD_merged) # dim = (3323038,8)
```

### Build EHR features
```{r}
# Get length of records
```


